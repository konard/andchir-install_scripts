#!/bin/bash
# Test script to verify the nginx configuration generated by openchatroulette.sh
# This script simulates generating the nginx config and validates its structure

set -e

# Test configuration values
DOMAIN_NAME="chat.example.com"
FRONTEND_DIR="/home/installer_user/openchatroulette/openchatroulette"
APP_PORT="9000"

# Generate nginx config to a temp file
NGINX_CONF=$(cat << 'EOF'
server {
    listen 80;
    server_name chat.example.com;

    access_log /var/log/nginx/chat.example.com_access.log;
    error_log /var/log/nginx/chat.example.com_error.log;

    root /home/installer_user/openchatroulette/openchatroulette/dist/openchatroulette;

    # Default root path redirects to English version
    location = / {
        return 302 /en/;
    }

    # Language-specific paths (en, ru, fr, ua)
    location ~ ^/(en|ru|fr|ua)(/.*)?$ {
        alias /home/installer_user/openchatroulette/openchatroulette/dist/openchatroulette/$1/;
        index index.html;
        try_files $2 $2/ /$1/index.html;
    }

    # Peer server WebSocket/API proxy
    location /openchatroulette {
        proxy_pass http://127.0.0.1:9000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    client_max_body_size 10M;
}
EOF
)

echo "Generated nginx configuration for OpenChatRoulette:"
echo "====================================================="
echo "$NGINX_CONF"
echo ""
echo "====================================================="
echo "Test Results:"
echo ""

# Test 1: Root redirect to English
if echo "$NGINX_CONF" | grep -q 'location = /'; then
    echo "✔ Root location block exists"
else
    echo "✖ Root location block missing"
    exit 1
fi

if echo "$NGINX_CONF" | grep -q 'return 302 /en/'; then
    echo "✔ Root redirects to /en/"
else
    echo "✖ Root redirect to /en/ missing"
    exit 1
fi

# Test 2: Language-specific paths
if echo "$NGINX_CONF" | grep -q 'location ~ \^/(en|ru|fr|ua)'; then
    echo "✔ Language-specific location block exists"
else
    echo "✖ Language-specific location block missing"
    exit 1
fi

# Test 3: WebSocket proxy
if echo "$NGINX_CONF" | grep -q 'location /openchatroulette'; then
    echo "✔ WebSocket proxy location block exists"
else
    echo "✖ WebSocket proxy location block missing"
    exit 1
fi

if echo "$NGINX_CONF" | grep -q 'proxy_set_header Upgrade'; then
    echo "✔ WebSocket upgrade headers present"
else
    echo "✖ WebSocket upgrade headers missing"
    exit 1
fi

# Test 4: Verify alias directive for language folders
if echo "$NGINX_CONF" | grep -q 'alias.*dist/openchatroulette/\$1/'; then
    echo "✔ Language folder alias configured correctly"
else
    echo "✖ Language folder alias not configured"
    exit 1
fi

# Test 5: Verify try_files for Angular routing
if echo "$NGINX_CONF" | grep -q 'try_files'; then
    echo "✔ try_files directive present for Angular SPA routing"
else
    echo "✖ try_files directive missing"
    exit 1
fi

echo ""
echo "====================================================="
echo "All tests passed successfully!"
echo ""
echo "Expected behavior:"
echo "  https://example.com/     -> redirects to https://example.com/en/"
echo "  https://example.com/en/  -> serves English version"
echo "  https://example.com/ru/  -> serves Russian version"
echo "  https://example.com/fr/  -> serves French version"
echo "  https://example.com/ua/  -> serves Ukrainian version"
