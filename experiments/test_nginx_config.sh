#!/bin/bash
# Test script to verify the nginx configuration generated by xray-3x-ui.sh
# This script simulates generating the nginx config and validates it

set -e

# Test configuration values
DOMAIN_NAME="test.example.com"
WEB_BASE_PATH="abcd1234efgh5678"
APP_PORT="2053"
SUB_PORT="2096"

# Generate nginx config to a temp file
NGINX_CONF=$(cat << EOF
server {
    listen 80;
    server_name $DOMAIN_NAME;

    access_log /var/log/nginx/${DOMAIN_NAME}_access.log;
    error_log /var/log/nginx/${DOMAIN_NAME}_error.log;

    location /${WEB_BASE_PATH} {
        proxy_pass http://127.0.0.1:$APP_PORT/${WEB_BASE_PATH};
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    location /ws {
        proxy_pass http://127.0.0.1:$APP_PORT;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    # Subscription service - proxied via nginx for HTTPS support
    location /sub {
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header Host \$http_host;
        proxy_set_header X-Forwarded-Host \$http_host;
        proxy_set_header X-Forwarded-Port \$server_port;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header Range \$http_range;
        proxy_set_header If-Range \$http_if_range;
        proxy_redirect off;
        proxy_pass http://127.0.0.1:$SUB_PORT;
    }

    # JSON subscription service
    location /json {
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header Host \$http_host;
        proxy_set_header X-Forwarded-Host \$http_host;
        proxy_set_header X-Forwarded-Port \$server_port;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header Range \$http_range;
        proxy_set_header If-Range \$http_if_range;
        proxy_redirect off;
        proxy_pass http://127.0.0.1:$SUB_PORT;
    }

    client_max_body_size 100M;
}
EOF
)

echo "Generated nginx configuration:"
echo "==============================="
echo "$NGINX_CONF"
echo ""
echo "==============================="
echo "Test Results:"
echo "- /sub location block: $(echo "$NGINX_CONF" | grep -c 'location /sub' && echo 'PASS' || echo 'FAIL')"
echo "- /json location block: $(echo "$NGINX_CONF" | grep -c 'location /json' && echo 'PASS' || echo 'FAIL')"
echo "- Subscription port 2096: $(echo "$NGINX_CONF" | grep -c "127.0.0.1:$SUB_PORT" && echo 'PASS' || echo 'FAIL')"
echo "- X-Forwarded-Proto header: $(echo "$NGINX_CONF" | grep -c 'X-Forwarded-Proto' && echo 'PASS' || echo 'FAIL')"
echo ""
echo "All tests completed successfully!"
